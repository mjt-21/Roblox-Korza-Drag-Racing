-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- Variables
local button = script.Parent
local StatsFrame = script.Parent.Parent.Stats
local StatsRemote = ReplicatedStorage:WaitForChild("RaceStats")
local RaceEndRemote = ReplicatedStorage:WaitForChild("GUIRaceEnd")
local LocalPlayerName = Players.LocalPlayer.Name

local PlayerName1 = script.Parent.Parent.Stats:WaitForChild("PlayerName1")
local PlayerName2 = script.Parent.Parent.Stats:WaitForChild("PlayerName2")
local PlayerName3 = script.Parent.Parent.Stats:WaitForChild("PlayerName3")
local PlayerName4 = script.Parent.Parent.Stats:WaitForChild("PlayerName4")

local PlayerTime1 = script.Parent.Parent.Stats:WaitForChild("PlayerTime1")
local PlayerTime2 = script.Parent.Parent.Stats:WaitForChild("PlayerTime2")
local PlayerTime3 = script.Parent.Parent.Stats:WaitForChild("PlayerTime3")
local PlayerTime4 = script.Parent.Parent.Stats:WaitForChild("PlayerTime4")

local PlayerPlacementLabel = script.Parent.Parent:WaitForChild("PlayerPlacement")
local PlayerTimeLabel = script.Parent.Parent:WaitForChild("PlayerTime")

button.MouseButton1Click:Connect(function()
	if StatsFrame.Visible == false then
		StatsFrame.Visible = true
		button.Text = "Close Race Stats"
	elseif
		StatsFrame.Visible == true then
		StatsFrame.Visible = false
		button.Text = "View Race Stats"
	end
end)

StatsRemote.OnClientEvent:Connect(function(PlayerAssignments)
	table.sort(PlayerAssignments, function(a, b)
    	return a.TimeValue < b.TimeValue
	end)
	
	PlayerName1.Text = PlayerAssignments[1].Name
	PlayerName2.Text = PlayerAssignments[2].Name
	PlayerName3.Text = PlayerAssignments[3].Name
	PlayerName4.Text = PlayerAssignments[4].Name
	
	PlayerTime1.Text = string.format("%0.3f", tostring(PlayerAssignments[1].TimeValue))
	PlayerTime2.Text = string.format("%0.3f", tostring(PlayerAssignments[2].TimeValue))
	PlayerTime3.Text = string.format("%0.3f", tostring(PlayerAssignments[3].TimeValue))
	PlayerTime4.Text = string.format("%0.3f", tostring(PlayerAssignments[4].TimeValue))
end)

RaceEndRemote.OnClientEvent:Connect(function(PlayerAssignments)
	local PlayerPlace = nil
	if LocalPlayerName == PlayerName1.Text then
		PlayerPlace = "1st"
	elseif LocalPlayerName == PlayerName2.Text then
		PlayerPlace = "2nd"
	elseif LocalPlayerName == PlayerName3.Text then
		PlayerPlace = "3rd"
	elseif LocalPlayerName == PlayerName4.Text then
		PlayerPlace = "4th"
	end
	
	for _, Players in pairs(PlayerAssignments) do
		if Players.Name == LocalPlayerName then
			button.Visible = false
			
			if StatsFrame.Visible == true then
				StatsFrame.Visible = false
			end
			
			PlayerPlacementLabel.Visible = true
			PlayerTimeLabel.Visible = true
			PlayerPlacementLabel.Text = ("You Came In : " .. PlayerPlace .. " Place!")
			PlayerTimeLabel.Text = ("Your Time : " .. string.format("%0.3f", tostring(Players.TimeValue)))
			
			wait(3)
			
			PlayerPlacementLabel.Visible = false
			PlayerTimeLabel.Visible = false
			
			StatsFrame.Visible = true
			wait(5)
			StatsFrame.Visible = false
			button.Visible = true
			
			break
		end
	end
end)
